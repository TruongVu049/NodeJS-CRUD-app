<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="/client/assets/favicon/logos-s-favicon.png">

    <!-- =================== FONTS AWESOME 6.4.0 -->
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ================== BOOTSTRAP 4.1 ========= -->
    <!-- <link rel="stylesheet" type="text/css" href="/client/assets/css/bootstrap-grid.css"> -->

    <!-- ================== style.css =============== -->
    <link rel="stylesheet" type="text/css" href="/public/css/dashboard.css">

    <!-- ================== responsive =================== -->
    <!-- <link rel="stylesheet" type="text/css" href="/assets/css/responsive.css"> -->
    <title>Dashboard</title>
</head>


<body>
    <div class="app-container edit-page">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-icon">
                    <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                        <path fill="currentColor"
                            d="M507.606 371.054a187.217 187.217 0 00-23.051-19.606c-17.316 19.999-37.648 36.808-60.572 50.041-35.508 20.505-75.893 31.452-116.875 31.711 21.762 8.776 45.224 13.38 69.396 13.38 49.524 0 96.084-19.286 131.103-54.305a15 15 0 004.394-10.606 15.028 15.028 0 00-4.395-10.615zM27.445 351.448a187.392 187.392 0 00-23.051 19.606C1.581 373.868 0 377.691 0 381.669s1.581 7.793 4.394 10.606c35.019 35.019 81.579 54.305 131.103 54.305 24.172 0 47.634-4.604 69.396-13.38-40.985-.259-81.367-11.206-116.879-31.713-22.922-13.231-43.254-30.04-60.569-50.039zM103.015 375.508c24.937 14.4 53.928 24.056 84.837 26.854-53.409-29.561-82.274-70.602-95.861-94.135-14.942-25.878-25.041-53.917-30.063-83.421-14.921.64-29.775 2.868-44.227 6.709-6.6 1.576-11.507 7.517-11.507 14.599 0 1.312.172 2.618.512 3.885 15.32 57.142 52.726 100.35 96.309 125.509zM324.148 402.362c30.908-2.799 59.9-12.454 84.837-26.854 43.583-25.159 80.989-68.367 96.31-125.508.34-1.267.512-2.573.512-3.885 0-7.082-4.907-13.023-11.507-14.599-14.452-3.841-29.306-6.07-44.227-6.709-5.022 29.504-15.121 57.543-30.063 83.421-13.588 23.533-42.419 64.554-95.862 94.134zM187.301 366.948c-15.157-24.483-38.696-71.48-38.696-135.903 0-32.646 6.043-64.401 17.945-94.529-16.394-9.351-33.972-16.623-52.273-21.525-8.004-2.142-16.225 2.604-18.37 10.605-16.372 61.078-4.825 121.063 22.064 167.631 16.325 28.275 39.769 54.111 69.33 73.721zM324.684 366.957c29.568-19.611 53.017-45.451 69.344-73.73 26.889-46.569 38.436-106.553 22.064-167.631-2.145-8.001-10.366-12.748-18.37-10.605-18.304 4.902-35.883 12.176-52.279 21.529 11.9 30.126 17.943 61.88 17.943 94.525.001 64.478-23.58 111.488-38.702 135.912zM266.606 69.813c-2.813-2.813-6.637-4.394-10.615-4.394a15 15 0 00-10.606 4.394c-39.289 39.289-66.78 96.005-66.78 161.231 0 65.256 27.522 121.974 66.78 161.231 2.813 2.813 6.637 4.394 10.615 4.394s7.793-1.581 10.606-4.394c39.248-39.247 66.78-95.96 66.78-161.231.001-65.256-27.511-121.964-66.78-161.231z" />
                    </svg>
                </div>
            </div>
            <ul class="sidebar-list">
                <li class="sidebar-list-item">
                    <a href="/">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-home">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg>
                        <span>Trang Chủ</span>
                    </a>
                </li>
                <li class="sidebar-list-item active">
                    <a href="/dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="feather feather-shopping-bag">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <path d="M16 10a4 4 0 0 1-8 0" />
                        </svg>
                        <span>Sản Phẩm</span>
                    </a>
                </li>
            </ul>
            <div class="account-info">

            </div>
        </div>
        <div class="app-content">
            <div class="app-content-header">
                <h1 class="app-content-headerText">Sản Phẩm</h1>
                <button class="mode-switch" title="Switch Theme">
                    <svg class="moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2" width="24" height="24" viewBox="0 0 24 24">
                        <defs></defs>
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
                </button>
            </div>
            <div class="app-content-actions">
                <input class="search-bar" placeholder="Search..." type="text">
                <div class="app-content-actions-wrapper">

                    <!-- <button class="app-content-headerButton">Add Product
                        <a href="http://localhost:5000/dashboard/edit"></a>
                    </button> -->
                </div>
            </div>
            <div class="products-area-wrapper tableView">
                <div class="container">
                    <div class="form-i">
                        <form method="POST" action="/upload" enctype="multipart/form-data">
                            <div class="rows">
                                <label for="product-id">Mã Sản Phẩm</label>
                                <input name="product-id" type="text" data-id="" id="product-id"
                                    placeholder="Mã sản phẩm">
                            </div>
                            <div class="rows">
                                <label for="product-name">Tên Sản Phẩm</label>
                                <textarea name="product-name" name="name" id="product-name" cols="30" rows="4"
                                    placeholder="Tên sản phẩm"></textarea>
                            </div>
                            <div class="rows-select">
                                <div class="select-type">
                                    <label for="product-type">Danh mục</label>
                                    <select name="product-type" data-type="" id="product-type">
                                        <option value="L001">Áo</option>
                                        <option value="L002">Quần</option>
                                        <option value="L003">Giày</option>
                                        <option value="L004">Nón</option>
                                    </select>
                                </div>
                                <div class="select-brand">
                                    <label for="product-brand">Thương Hiệu</label>
                                    <select name="product-brand" data-type="" id="product-brand">
                                        <option value="TH001">Nike</option>
                                        <option value="TH002">Cafina</option>
                                        <option value="TH003">Adidas</option>
                                        <option value="TH004">Fila</option>
                                        <option value="TH005">Tman</option>
                                    </select>
                                </div>
                            </div>
                            <div class="rows">
                                <label for="product-price">Giá</label>
                                <input type="text" data-price="" id="product-price" placeholder="Giá">
                            </div>
                            <div class="row-img">
                                <!-- <label>Avatar:</label> -->
                                <div>
                                    <label for="product-img">Ảnh</label>
                                    <input type="file" value-img="" name="image" id="product-image" />
                                </div>
                                <div class="img-upload">
                                </div>
                            </div>
                            <button class="btn-submit">Áp Dụng</button>
                        </form>
                    </div>
                </div>
            </div>
            <!--  -->
        </div>
    </div>
    <script>
        let idInput = document.querySelector("#product-id")
        let nameInput = document.querySelector("#product-name")
        let typeInput = document.querySelector("#product-type")
        let brandInput = document.querySelector("#product-brand")
        let priceInput = document.querySelector("#product-price")
        let imageInput = document.querySelector("#product-image");
        let btnPost = document.querySelector(".btn-submit");

        async function autoUploadImg() {
            const formData = new FormData();
            for (let i = 0; i < imageInput.files.length; i++) {
                formData.append("files", imageInput.files[i]);
            }
            fetch('/upload', {
                method: 'POST',
                body: formData, // Payload is formData object
            })
                .then(res => res.json())
                .then(data => console.log(data))
                .then(function () {
                    renderImg();
                })
        }

        const getURLSearch = () => {
            let urlParams = new URLSearchParams(location.search);
            let arr = {};
            for (const [key, value] of urlParams) {
                {
                    arr[key] = value;
                }
            }
            return arr;
        };

        async function renderImg(data = undefined) {
            let eImg = document.querySelector(".img-upload");
            if (!data) {
                addImg = imageInput.value.split(/[\\]/);
                addImg = addImg[addImg.length - 1];
                eImg.innerHTML = `
                <span></span>
                <img height="100px" width="100px" src="/public/images/${addImg}" alt="image">
            `
            } else {
                eImg.innerHTML = `
                <span></span>
                <img height="100px" width="100px" src="/public/images/${data}" alt="image">
                `
            }
        }

        async function fillInput(idInput, nameInput, typeInput, brandInput, priceInput, imageInput, data) {
            idInput.value = data[0].SP_ID;
            nameInput.value = data[0].Ten;
            typeInput.value = data[0].LOAI_ID;
            brandInput.value = data[0].TH_ID;
            priceInput.value = (data[0].Gia);
            imageInput.dataset.img = data[0].Img;
            if (imageInput.dataset.img)
                renderImg(imageInput.dataset.img);
        }
        async function postProduct() {
            let addImg;
            imageInput.addEventListener('change', async function () {
                await autoUploadImg();
                addImg = imageInput.value.split(/[\\]/);
                addImg = addImg[addImg.length - 1];
            })
            btnPost.addEventListener('click', async function (e) {
                e.preventDefault();

                const res = await fetch("/product", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "SP_ID": idInput.value,
                        "Ten": nameInput.value,
                        "LOAI_ID": typeInput.value,
                        "TH_ID": brandInput.value,
                        "GIA": parseFloat(priceInput.value),
                        "Img": addImg
                    })
                }).then(function (res) { console.log(res) })
                    .catch(function (res) { console.log(res) })
                    .finally(function () {
                        location.href = `${location.origin}/dashboard`;
                    })
            })
        }

        async function putProduct() {
            let addImg;
            imageInput.addEventListener('change', async function () {
                await autoUploadImg();
                addImg = imageInput.value.split(/[\\]/);
                addImg = addImg[addImg.length - 1];
            })
            btnPost.addEventListener('click', async function (e) {
                e.preventDefault();
                if (!addImg)
                    addImg = imageInput.dataset.img;
                const res = await fetch("/product", {
                    method: "PUT",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "SP_ID": idInput.value,
                        "Ten": nameInput.value,
                        "LOAI_ID": typeInput.value,
                        "TH_ID": brandInput.value,
                        "GIA": parseFloat(priceInput.value),
                        "Img": addImg
                    })
                }).then(function (res) { console.log(res) })
                    .catch(function (res) { console.log(res) })
                    .finally(function () {
                        location.href = `${location.origin}/dashboard`
                    })
            })
        }

        async function checkPage() {
            let params = getURLSearch();
            if (location.pathname.includes("edit")) {
                let data = await getListProduct(params.id);
                await fillInput(idInput, nameInput, typeInput, brandInput, priceInput, imageInput, data);
                putProduct();
            }
            else {
                postProduct();
            }

        }
        checkPage();
        async function getListProduct(id) {
            let url = `/product/${id}`;
            let res = await fetch(url, {
                method: "GET",
            });
            let data = await res.json();
            return data;
        }
    </script>
</body>

</html>